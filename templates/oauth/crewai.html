{% extends 'base.html' %}
{% load static %}

{% block title %}crewAI æ™ºèƒ½ä½“æ¼”ç¤º - {{ block.super }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'oauth/css/crewai.css' %}">
<!-- Markdown å’Œä»£ç é«˜äº®æ”¯æŒ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
{% endblock %}

{% block content %}
<div class="crewai-container">
    <div class="crewai-header">
        <h1 style="font-size: 24px; margin-bottom: 4px;">crewAI æ™ºèƒ½ä½“æ¼”ç¤º</h1>
        <p style="color: #8c8c8c; margin: 0;">é›†æˆ CSV RAG å·¥å…·ã€Human-in-the-loop å’Œæœ¬åœ° MCP Server è°ƒç”¨</p>
    </div>

    <!-- èŠå¤©å†å²åŒºåŸŸ -->
    <div class="chat-history-wrapper" id="chat-scroll-area">
        <div id="welcome-message" style="text-align: center; padding: 60px 0; color: #bfbfbf;">
            <i class="fas fa-robot" style="font-size: 64px; margin-bottom: 20px; opacity: 0.1;"></i>
            <h2 style="font-size: 20px; color: #595959; margin-bottom: 8px;">æ¬¢è¿ä½¿ç”¨ crewAI æ™ºèƒ½ä½“</h2>
            <p>é›†æˆ CSV RAGã€HITL å’Œ MCP Serverï¼ŒååŠ©æ‚¨å¤„ç†å¤æ‚ä»»åŠ¡</p>
        </div>

        <div id="chat-container" style="display: flex; flex-direction: column; gap: 0;">
            <!-- ç”¨æˆ·æ¶ˆæ¯æ°”æ³¡æ¨¡æ¿ -->
            <div id="user-message" class="chat-bubble user-bubble" style="display: none;">
                <div class="chat-avatar" style="width: 36px; height: 36px; border-radius: 50%; background: #1890ff; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    {% if user_info.avatar %}
                        <img src="{{ user_info.avatar }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                    {% elif user_info %}
                        {{ user_info.name|slice:":1"|upper }}
                    {% else %}
                        ğŸ‘¤
                    {% endif %}
                </div>
                <div style="background: #1890ff; color: #fff; padding: 12px 16px; border-radius: 16px 0 16px 16px; box-shadow: 0 2px 8px rgba(24,144,255,0.15); position: relative;">
                    <div id="user-query-text"></div>
                </div>
            </div>

            <!-- è¿è¡ŒçŠ¶æ€å’Œä¸­é—´è¿‡ç¨‹ -->
            <div id="status-container" style="display: none;">
                <div id="status-badge" style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; margin-bottom: 16px; font-weight: 500;"></div>
                
                <div style="display: flex; flex-direction: column; gap: 0;">
                    <!-- æ€è€ƒè¿‡ç¨‹æŠ˜å  -->
                    <div id="thinking-process" style="display: none; align-self: flex-start; width: 100%; margin-bottom: 24px;">
                        <details open class="thinking-details">
                            <summary class="thinking-summary">
                                <i class="fas fa-brain" style="color: #722ed1;"></i>
                                <span>æ™ºèƒ½ä½“æ€è€ƒè½¨è¿¹</span>
                                <span id="thinking-dots" style="margin-left: auto;"></span>
                            </summary>
                            <div id="log-content" class="thinking-content">
                                <!-- è§£æåçš„æ—¥å¿—å°†æ’å…¥åˆ°è¿™é‡Œ -->
                            </div>
                        </details>
                    </div>

                    <!-- HITL äº¤äº’åŒºåŸŸ -->
                    <div id="hitl-container" class="chat-bubble agent-bubble" style="display: none; width: 100%; background: #fffbe6; border: 1px solid #ffe58f; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 20px;">
                        <div style="display: flex; gap: 12px; align-items: flex-start;">
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: #faad14; color: #fff; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 8px 0; color: #856404; font-size: 15px;">éœ€è¦æ‚¨çš„åé¦ˆ</h4>
                                <p id="hitl-prompt" style="margin-bottom: 16px; color: #856404; line-height: 1.5;"></p>
                                <div style="display: flex; gap: 12px;">
                                    <input type="text" id="hitl-input" style="flex: 1; padding: 10px 14px; border: 1px solid #d9d9d9; border-radius: 8px; font-size: 14px;" placeholder="è¯·è¾“å…¥æ‚¨çš„å›ç­”...">
                                    <button id="hitl-submit" class="btn" style="background: #faad14; color: #fff; border: none; padding: 0 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                                        å‘é€
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æœ€ç»ˆç»“æœæ°”æ³¡ -->
                    <div id="result-container" class="chat-bubble agent-bubble" style="display: none; width: 100%; background: #fff; border: 1px solid #e8e8e8; border-radius: 0 16px 16px 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 20px;">
                        <div style="display: flex; gap: 12px; align-items: flex-start;">
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: #52c41a; color: #fff; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 2px 4px rgba(82,196,26,0.2);">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px; color: #262626;">æ™ºèƒ½ä½“æœ€ç»ˆå›ç­”</div>
                                <div id="result-content" class="markdown-body"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="loading-indicator" style="display: none; text-align: center; padding: 20px; margin-top: 10px;">
                    <div class="typing-indicator" style="display: inline-flex; gap: 4px; padding: 8px 16px; background: #f0f0f0; border-radius: 20px;">
                        <span style="width: 6px; height: 6px; background: #bfbfbf; border-radius: 50%; animation: typing 1s infinite 0s;"></span>
                        <span style="width: 6px; height: 6px; background: #bfbfbf; border-radius: 50%; animation: typing 1s infinite 0.2s;"></span>
                        <span style="width: 6px; height: 6px; background: #bfbfbf; border-radius: 50%; animation: typing 1s infinite 0.4s;"></span>
                    </div>
                    <p style="margin-top: 8px; color: #8c8c8c; font-size: 12px;">æ™ºèƒ½ä½“æ­£åœ¨æ‰§è¡Œä»»åŠ¡...</p>
                </div>
            </div>

            <div id="error-container" style="display: none; padding: 16px; background: #fff2f0; border: 1px solid #ffccc7; border-radius: 12px; color: #ff4d4f; margin-bottom: 24px;">
                <i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i>
                <strong>é”™è¯¯ï¼š</strong> <span id="error-message"></span>
            </div>
        </div>
    </div>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="chat-input-wrapper">
        <form id="agent-form">
            <div class="input-box-container">
                <textarea id="query" name="query" rows="1" placeholder="è¾“å…¥æŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼šWhat is the stock level of Laptop Pro?" required>{{ query }}</textarea>
            </div>
            <button type="submit" id="submit-btn">
                <i class="fas fa-paper-plane"></i>
                <span>è¿è¡Œ</span>
            </button>
            <button type="button" id="stop-btn">
                <i class="fas fa-stop-circle"></i>
                <span>åœæ­¢</span>
            </button>
        </form>

        <!-- åŠŸèƒ½è¯´æ˜ç®€è¿° -->
        <div id="mcp-servers-container" class="features-grid">
            <div class="feature-item" style="cursor: default;">
                <h4 style="color: #1890ff;"><i class="fas fa-file-csv"></i> CSV RAG</h4>
                <p>æ£€ç´¢æœ¬åœ°åº“å­˜æ•°æ®</p>
            </div>
            <div class="feature-item" style="cursor: default;">
                <h4 style="color: #52c41a;"><i class="fas fa-user-friends"></i> HITL</h4>
                <p>äººå·¥åé¦ˆç¡®è®¤</p>
            </div>
            <!-- åŠ¨æ€åŠ è½½çš„ MCP æœåŠ¡å™¨å°†æ’å…¥è¿™é‡Œ -->
            <div id="mcp-loading" class="feature-item" style="display: flex; align-items: center; justify-content: center; border-style: dashed; cursor: default;">
                <i class="fas fa-spinner fa-spin" style="margin-right: 8px; color: #bfbfbf;"></i>
                <span style="color: #bfbfbf;">æ­£åœ¨åŠ è½½ MCP é…ç½®...</span>
            </div>
        </div>
    </div>
</div>

<!-- å·¥å…·è¯¦æƒ… Modal -->
<div id="tool-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title" style="margin: 0; font-size: 18px; color: #262626;"></h3>
            <button class="close-btn" id="close-modal">&times;</button>
        </div>
        <div class="modal-body" id="modal-body">
            <!-- å·¥å…·åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- ä¼ é€’ Django å˜é‡ç»™å¤–éƒ¨ JS -->
<script>
    window.CrewAIConfig = {
        runUrl: "{% url 'crewai_run' %}",
        csrfToken: "{{ csrf_token }}",
        userAvatar: "{% if user_info.avatar %}{{ user_info.avatar }}{% elif user_info %}{{ user_info.name|slice:':1'|upper }}{% else %}ğŸ‘¤{% endif %}"
    };
</script>

<!-- Markdown è§£æå’Œä»£ç é«˜äº®åº“ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<!-- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ -->
<script src="{% static 'oauth/js/crewai.js' %}"></script>
{% endblock %}
